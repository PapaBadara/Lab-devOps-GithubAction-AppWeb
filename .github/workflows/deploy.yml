name: Deploy to Remote VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted  # Le runner est local ou sur une autre machine

    steps:
      - name: Cloner le d√©p√¥t
        uses: actions/checkout@v4

      - name: D√©ployer sur la VM via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}         # IP ou hostname de la VM
          username: ${{ secrets.VM_USER }}     # Utilisateur SSH
          key: ${{ secrets.VM_SSH_KEY }}       # Cl√© priv√©e SSH stock√©e dans GitHub Secrets
          script: |
            echo "üßπ Arr√™t et suppression de l'ancien conteneur..."
            docker rm -f uam-nginx-app || true

            echo "üî® Construction et lancement du conteneur Docker..."
            docker build -t uam-nginx-app /home/${{ secrets.VM_USER }}/uam-nginx-lab
            docker run -d --name uam-nginx-app -p 30086:80 uam-nginx-app

            echo "‚úÖ Conteneur lanc√© sur la VM"
