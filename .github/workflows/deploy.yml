name: Deploy to VM via Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Nettoyer le dossier cible sur la VM
      - name: Clean target folder on VM
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            echo "üßπ Nettoyage du dossier /home/${{ secrets.VM_USER }}/uam-nginx-lab..."
            rm -rf /home/${{ secrets.VM_USER }}/uam-nginx-lab
            mkdir -p /home/${{ secrets.VM_USER }}/uam-nginx-lab
            echo "‚úÖ Dossier nettoy√©"

      # 3Ô∏è‚É£ Copier le projet sur la VM
      - name: Copy files to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "./*"
          target: "/home/${{ secrets.VM_USER }}/uam-nginx-lab"

      # 4Ô∏è‚É£ Build et run Docker sur la VM
      - name: Build and run Docker on VM
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            echo "üßπ Arr√™t et suppression de l'ancien conteneur Docker..."
            docker rm -f uam-nginx-app || true

            echo "üî® Construction de l'image Docker..."
            docker build -t uam-nginx-app /home/${{ secrets.VM_USER }}/uam-nginx-lab

            echo "üöÄ Lancement du conteneur sur le port 30086..."
            docker run -d --name uam-nginx-app -p 30086:80 uam-nginx-app

            echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
